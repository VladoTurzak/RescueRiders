<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rescue Riders ‚Äî Play Now</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:Arial,Helvetica,sans-serif}
    /* Len ƒçierne pozadie; mission pozadie kresl√≠ hra */
    body{background:#000}

    /* Portr√©t zablokovan√Ω (iba touch) */
    #rotate-block{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:#000; color:#fff; text-align:center; z-index:9999; padding:24px;
    }
    #rotate-block .card{max-width:560px}
    #rotate-block h3{margin:0 0 8px; font-size:22px}
    @media (pointer:coarse) and (orientation:portrait){ #rotate-block{display:flex} }

    /* Hra (canvas bude 4:3 uprostred) */
    #game-container{position:fixed; inset:0; z-index:1; display:none}

    /* Nick dialog */
    #nickname-form{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,.65); padding:32px 40px; border-radius:14px; color:#fff; text-align:center;
      z-index:10000; box-shadow:0 0 30px rgba(0,0,0,.6);
    }
    #nickname-form h2{margin:0 0 8px; color:#ffcc00}
    #nickname-form input{width:80%; padding:10px; border:none; border-radius:8px; text-align:center; outline:none; background:#fff; color:#000}
    #nickname-form button{margin-top:12px; padding:10px 22px; border:none; border-radius:8px; background:#ffcc00; color:#000; font-weight:700; cursor:pointer}

    /* Joystick (touch, landscape) ‚Äì v√§ƒç≈°√≠, citlivej≈°√≠, ƒæav√Ω doln√Ω roh canvasu */
    :root{ --joy: min(26vmin, 150px); --knob: calc(var(--joy)*.34); --pad: 16px }
    #rr-joy{ position:fixed; width:var(--joy); height:var(--joy); touch-action:none; display:none; z-index:5 }
    #rr-joy-base{ position:absolute; inset:0; border-radius:50%; background:rgba(255,255,255,.10); border:2px solid rgba(255,255,255,.30) }
    #rr-joy-knob{ position:absolute; width:var(--knob); height:var(--knob); border-radius:50%; background:rgba(255,255,255,.85); box-shadow:0 0 14px rgba(0,0,0,.5); left:calc(50% - var(--knob)/2); top:calc(50% - var(--knob)/2); will-change:transform; transition:transform .02s linear }
    @media (pointer:coarse) and (orientation:landscape){ #rr-joy{display:block} }
  </style>
</head>
<body>
  <div id="rotate-block"><div class="card"><h3>Rotate your device</h3><p>Playable only in <b>landscape</b>.</p></div></div>

  <div id="nickname-form">
    <h2>üåä Rescue Riders</h2>
    <p>Enter your nickname to begin:</p>
    <input id="nickname" maxlength="12" placeholder="Your name" autofocus />
    <br /><button id="start-btn">Start Game</button>
  </div>

  <div id="game-container">
    <div id="rr-joy"><div id="rr-joy-base"></div><div id="rr-joy-knob"></div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
  <script>
    const form = document.getElementById('nickname-form');
    const startBtn = document.getElementById('start-btn');
    const input = document.getElementById('nickname');
    const container = document.getElementById('game-container');

    function bootGame(){
      const s=document.createElement('script'); s.src='main.js'; document.body.appendChild(s);

      // Canvas FIT (len CSS): pl√°tno 900√ó600 ≈°k√°lujeme uniformne, centrum do okna
      const GW=900, GH=600, R=GW/GH;
      const joy=document.getElementById('rr-joy'), knob=document.getElementById('rr-joy-knob'), base=document.getElementById('rr-joy-base');

      function applyFit(){
        const cv=document.querySelector('#game-container canvas')||document.querySelector('canvas'); if(!cv) return;
        const WW=innerWidth, WH=innerHeight;
        let w,h; if(WW/WH>R){ h=WH; w=Math.floor(h*R);} else { w=WW; h=Math.floor(w/R); }
        cv.style.position='absolute'; cv.style.width=w+'px'; cv.style.height=h+'px';
        cv.style.left=((WW-w)/2)+'px'; cv.style.top=((WH-h)/2)+'px';

        // joystick k ƒæav√©mu doln√©mu rohu canvasu (v≈ædy vn√∫tri)
        const pad=16; const joyH=parseFloat(getComputedStyle(joy).height)||0;
        joy.style.left=((WW-w)/2 + pad)+'px';
        joy.style.top=((WH-h)/2 + h - joyH - pad)+'px';
      }

      const wait=setInterval(()=>{ const cv=document.querySelector('#game-container canvas')||document.querySelector('canvas');
        if(cv){ clearInterval(wait); applyFit(); addEventListener('resize',applyFit); } },20);

      // Joystick ‚Äì v√§ƒç≈°√≠ rozsah, ni≈æ≈°√≠ prah, drag z celej plochy
      (function(){
        const touchLandscape = matchMedia('(pointer:coarse)').matches && matchMedia('(orientation:landscape)').matches;
        if(!touchLandscape) return;
        let state={L:false,R:false,U:false,D:false};
        const send=(key,type)=>{ const map={ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40};
          window.dispatchEvent(new KeyboardEvent(type,{key,code:key,keyCode:map[key],which:map[key],bubbles:true})); };

        function center(){ const r=joy.getBoundingClientRect(); return {x:r.left+r.width/2,y:r.top+r.height/2,rad:Math.min(r.width,r.height)*0.48}; }
        function move(x,y){
          const c=center(); let dx=x-c.x, dy=y-c.y; const len=Math.hypot(dx,dy)||1, R=c.rad;
          if(len>R){dx=dx/len*R;dy=dy/len*R}
          knob.style.transform=`translate(${dx}px,${dy}px)`;
          const nx=dx/R, ny=dy/R; const TH=.20; // citlivej≈°√≠ prah
          const want={L:nx<-TH,R:nx>TH,U:ny<-TH,D:ny>TH};
          if(want.L&&!state.L)send('ArrowLeft','keydown'); if(!want.L&&state.L)send('ArrowLeft','keyup');
          if(want.R&&!state.R)send('ArrowRight','keydown'); if(!want.R&&state.R)send('ArrowRight','keyup');
          if(want.U&&!state.U)send('ArrowUp','keydown');   if(!want.U&&state.U)send('ArrowUp','keyup');
          if(want.D&&!state.D)send('ArrowDown','keydown'); if(!want.D&&state.D)send('ArrowDown','keyup');
          state=want;
        }
        function release(){ knob.style.transform='translate(0px,0px)'; ['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].forEach(k=>send(k,'keyup')); state={L:false,R:false,U:false,D:false}; }

        // zachyt√°vaj dotyky z celej plochy joy (ƒæah≈°ie trafi≈•)
        joy.addEventListener('touchstart',e=>{const t=e.changedTouches[0];move(t.clientX,t.clientY)},{passive:true});
        joy.addEventListener('touchmove', e=>{const t=e.changedTouches[0];move(t.clientX,t.clientY)},{passive:true});
        joy.addEventListener('touchend',  release,{passive:true});
        joy.addEventListener('touchcancel',release,{passive:true});
        addEventListener('resize', release);
      })();
    }

    function startGame(){
      const nick = input.value.trim(); if(!nick){alert('Please enter your nickname'); return;}
      localStorage.setItem('rr_nickname', nick);
      form.style.display='none';
      container.style.display='block';
      bootGame();
    }
    startBtn.addEventListener('click', startGame);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter') startGame(); });

    addEventListener('load', ()=>{
      if(localStorage.getItem('rr_nickname')){
        form.style.display='none'; container.style.display='block'; bootGame();
      }
    });
  </script>
</body>
</html>
